<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Record Visit</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        .card-header { font-weight: bold; }
        .ts-control { padding: 0.5rem !important; border-radius: 0.375rem !important; }
        .form-label { font-weight: 600; margin-top: 10px; }
    </style>
</head>
<body class="container mt-5">
    <div class="card shadow">
        <div class="card-header bg-dark text-white"><h3>Check-in / Check-out</h3></div>
        <div class="card-body">
            <form th:action="@{/visits}" method="post">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Selecting Customer</label>
                        <select name="customerId" id="customerSelect" class="form-select" required onchange="updateReturnList()">
                            <option value="">Search for a customer...</option>
                            <option th:each="c : ${customers}" th:value="${c.id}" th:text="${c.name}"></option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Assigned Librarian</label>
                        <select name="librarianId" id="librarianSelect" class="form-select" required>
                            <option th:each="l : ${librarians}" th:value="${l.id}" th:text="${l.name}"></option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Borrow Books</label>
                    <select id="borrowBooksSelect" name="borrowedBooksIds" multiple placeholder="Type to search available books..." autocomplete="off">
                        <option th:each="b : ${availableBooks}" th:if="${b.available}" 
                                th:value="${b.id}" th:text="${b.title}"></option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Return Books</label>
                    <select id="returnBooksSelect" name="returnedBooksIds" multiple placeholder="Select customer first..." autocomplete="off">
                    </select>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary px-4">Process Transaction</button>
                    <a href="/" class="btn btn-secondary px-4">Cancel</a>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <script>
        // Global variables to store the Tom Select instances
        let borrowTS, returnTS, customerTS;

        // Initialize Searchable Dropdowns on page load
        document.addEventListener("DOMContentLoaded", function() {
            customerTS = new TomSelect("#customerSelect", { create: false });
            new TomSelect("#librarianSelect", { create: false });
            
            borrowTS = new TomSelect("#borrowBooksSelect", {
                plugins: ['remove_button'],
                maxItems: 10,
                persist: false
            });

            // Return dropdown needs to be managed for dynamic updates
            returnTS = new TomSelect("#returnBooksSelect", {
                plugins: ['remove_button'],
                persist: false
            });
        });

        async function updateReturnList() {
            // Get value from the Tom Select instance instead of raw select
            const customerId = customerTS.getValue();
            
            if (!customerId) {
                returnTS.clearOptions();
                return;
            }

            try {
                const response = await fetch(`/customers/${customerId}/borrowed-books`);
                const books = await response.json();

                // 1. Clear current items in the return dropdown
                returnTS.clear();
                returnTS.clearOptions();

                if (books.length === 0) {
                    returnTS.settings.placeholder = "No books found for this customer";
                } else {
                    returnTS.settings.placeholder = "Search books to return...";
                    // 2. Add the new books as options
                    books.forEach(book => {
                        returnTS.addOption({
                            value: book.id,
                            text: book.title
                        });
                    });
                }
                
                // Refresh UI
                returnTS.refreshOptions(false);
                
            } catch (error) {
                console.error('Error fetching borrowed books:', error);
            }
        }
    </script>
</body>
</html>